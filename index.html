<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Gimolo ‚Äî Single-File Prototype (v5: full mechanics)</title>
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0c1220;overflow-x:hidden}
  :root{
    --ink:#0c1220;--muted:rgba(12,18,32,.66);
    --glass:rgba(255,255,255,.76);--glass2:rgba(255,255,255,.90);
    --shadow:0 24px 70px rgba(0,0,0,.14);--shadow2:0 14px 40px rgba(0,0,0,.10);
    --r:26px;--pill:999px;
    --mint:#74e3b0;--blue:#4aa3ff;--purple:#b57bff;--warm:#ffb86b;--pink:#ff6fb1;
    --bgA:#d8fff0; --bgB:#dfe8ff;
  }
  body.v1{ --mint:#74e3b0;--blue:#4aa3ff;--purple:#b57bff;--warm:#ffb86b;--pink:#ff6fb1; --bgA:#d8fff0; --bgB:#dfe8ff; }
  body.v2{ --mint:#7cf2ff;--blue:#5a7bff;--purple:#d26bff;--warm:#ffda6a;--pink:#ff5f7e; --bgA:#e7fbff; --bgB:#efe7ff; }
  body.v3{ --mint:#8cffc1;--blue:#2fd0ff;--purple:#7c5cff;--warm:#ff9f5f;--pink:#ff63c6; --bgA:#eafff3; --bgB:#e6f4ff; }
  body.v4{ --mint:#98ff83;--blue:#34b3ff;--purple:#ff7bd4;--warm:#ffd86b;--pink:#ff5a6b; --bgA:#f0ffe9; --bgB:#e9f4ff; }

  .bg{position:fixed;inset:0;background:
    radial-gradient(900px 600px at 18% 10%, rgba(116,227,176,.55), transparent 60%),
    radial-gradient(900px 700px at 82% 35%, rgba(74,163,255,.45), transparent 60%),
    radial-gradient(700px 500px at 55% 95%, rgba(181,123,255,.30), transparent 65%),
    linear-gradient(135deg,var(--bgA),var(--bgB));}
  .noise{position:fixed;inset:-50%;opacity:.10;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="180" height="180" filter="url(%23n)" opacity="0.55"/></svg>');
    transform:rotate(7deg);pointer-events:none;}
  .shell{position:relative;max-width:430px;min-height:100vh;margin:0 auto;
    padding:env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 8px);
    display:flex;flex-direction:column;}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:18px 2px 10px;gap:10px;}
  .leftstack{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
  .brandpill{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--pill);
    background:var(--glass);box-shadow:var(--shadow2);backdrop-filter:blur(12px);}
  .mark{width:26px;height:26px;position:relative}
  .mark span{position:absolute;width:14px;height:14px;border-radius:50%}
  .mark .a{left:0;top:0;background:var(--pink)}
  .mark .b{right:0;top:0;background:var(--warm)}
  .mark .c{left:0;bottom:0;background:var(--blue)}
  .mark .d{right:0;bottom:0;background:var(--mint)}
  .brand{font-weight:1000;letter-spacing:-.2px;white-space:nowrap}
  .backbtn{
    border:none;background:var(--glass);box-shadow:var(--shadow2);backdrop-filter:blur(12px);
    border-radius:var(--pill);padding:10px 12px;cursor:pointer;font-weight:1000;display:none;
  }
  .backbtn.show{display:inline-flex}

  .iconbtn{border:none;background:var(--glass);box-shadow:var(--shadow2);backdrop-filter:blur(12px);
    border-radius:var(--pill);padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;}
  .pulseDot{width:10px;height:10px;border-radius:50%;background:var(--mint);animation:ping 1.8s ease-in-out infinite;}
  @keyframes ping{0%{box-shadow:0 0 0 0 rgba(116,227,176,0)}35%{box-shadow:0 0 0 10px rgba(116,227,176,.20)}100%{box-shadow:0 0 0 18px rgba(116,227,176,0)}}
  .avatar{width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,#d8dbe6,#fff)}

  .tog{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:var(--pill);background:var(--glass);
    box-shadow:var(--shadow2);backdrop-filter:blur(12px);cursor:pointer;user-select:none}
  .tog .lbl{font-weight:1000;font-size:12.5px;color:rgba(12,18,32,.74)}
  .switch{width:38px;height:22px;border-radius:999px;background:rgba(12,18,32,.14);position:relative}
  .knob{position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.95);
    box-shadow:0 8px 18px rgba(0,0,0,.15);transition:transform .18s ease,background .18s ease}
  .tog.on .switch{background:rgba(116,227,176,.55)}
  .tog.on .knob{transform:translateX(16px);background:#fff}

  .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:8px 0 12px;position:relative;}
  .card{width:100%;border-radius:var(--r);background:var(--glass2);backdrop-filter:blur(16px);box-shadow:var(--shadow);
    padding:22px 20px;transform-origin:50% 30%;}
  .enter{animation:popIn .42s cubic-bezier(.2,.9,.2,1) both;}
  @keyframes popIn{from{opacity:0;transform:translateY(14px) scale(.985)}to{opacity:1;transform:translateY(0) scale(1)}}
  .h1{margin:0;font-size:34px;line-height:1.05;letter-spacing:-.7px}
  .h2{margin:0;font-size:26px;line-height:1.1;letter-spacing:-.4px}
  .p{margin:10px 0 0;color:var(--muted);font-size:16px;line-height:1.35}
  .tagrow{display:flex;flex-wrap:wrap;gap:8px;margin:2px 0 14px}
  .tag{font-size:13px;padding:7px 10px;border-radius:var(--pill);background:rgba(12,18,32,.06);
    color:rgba(12,18,32,.72);display:inline-flex;align-items:center;gap:7px}
  .tag i{font-style:normal;opacity:.85}
  .div{height:1px;background:rgba(12,18,32,.08);margin:16px 0}
  .btn{width:100%;border:none;border-radius:var(--pill);padding:16px 16px;font-weight:1000;letter-spacing:.2px;cursor:pointer;font-size:16px;transition:transform .12s ease,filter .12s ease}
  .btn:active{transform:scale(.99);filter:brightness(.98)}
  .primary{color:#fff;background:linear-gradient(90deg,var(--blue),var(--mint));box-shadow:0 16px 34px rgba(74,163,255,.22)}
  .secondary{background:rgba(12,18,32,.06);color:rgba(12,18,32,.72);margin-top:10px}
  .ghost{background:transparent;color:rgba(12,18,32,.72);border:1px solid rgba(12,18,32,.14);margin-top:10px}

  /* Spin */
  .spinWrap{width:100%;display:flex;flex-direction:column;align-items:center;gap:14px;position:relative}
  .filters{width:100%;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .chip{border:none;border-radius:var(--pill);padding:10px 12px;background:var(--glass);box-shadow:var(--shadow2);
    backdrop-filter:blur(12px);cursor:pointer;color:rgba(12,18,32,.78);font-weight:1000;font-size:12.5px;
    display:inline-flex;align-items:center;gap:8px}
  .chip .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--mint))}
  .chip .val{opacity:.78;font-weight:1000}
  .chip .count{opacity:.65;font-weight:900;margin-left:2px}

  .orb{width:252px;height:252px;border-radius:50%;border:none;cursor:pointer;position:relative;display:grid;place-items:center;color:#fff;
    font-weight:1000;letter-spacing:1px;font-size:44px;text-shadow:0 10px 26px rgba(0,0,0,.26);
    background:radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 40%),
             conic-gradient(from 40deg, var(--mint), var(--blue), var(--purple), var(--warm), var(--pink), var(--mint));
    box-shadow:0 30px 80px rgba(0,0,0,.18), inset 0 0 0 10px rgba(255,255,255,.14);transform:translateZ(0);}
  .orb::before{content:"";position:absolute;inset:-26px;border-radius:50%;
    background:radial-gradient(circle, rgba(74,163,255,.30), transparent 64%);filter:blur(1px);z-index:-1;}
  .orbGlow{position:absolute;inset:-36px;border-radius:50%;
    background:radial-gradient(circle, rgba(116,227,176,.24), transparent 62%);filter:blur(10px);opacity:.92;z-index:-2;
    animation:breathe 2.6s ease-in-out infinite;}
  @keyframes breathe{0%,100%{transform:scale(.98);opacity:.80}50%{transform:scale(1.02);opacity:1}}

  .subpill{border:none;border-radius:var(--pill);padding:12px 16px;background:var(--glass);box-shadow:var(--shadow2);
    backdrop-filter:blur(12px);cursor:pointer;color:rgba(12,18,32,.78);font-weight:1000}
  .subpill small{font-weight:900;opacity:.72}

  /* Modal (fixes the "filter not showing" issue by using full-screen safe modal, not a bottom sheet) */
  .modalScrim{position:fixed;inset:0;background:rgba(0,0,0,.22);backdrop-filter:blur(4px);display:none;z-index:80}
  .modalScrim.show{display:block}
  .modal{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(430px, calc(100% - 24px));
    max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    overflow:auto;
    padding:14px 14px 16px;
    background:rgba(255,255,255,.94);backdrop-filter: blur(14px);
    border-radius:22px;box-shadow:0 24px 80px rgba(0,0,0,.25);
    display:none;z-index:90;
  }
  .modal.show{display:block; animation:popIn .22s cubic-bezier(.2,.9,.2,1) both;}
  .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;position:sticky;top:0;background:rgba(255,255,255,.94);padding:2px 0 10px}
  .modalTitle{font-weight:1000;letter-spacing:-.2px}
  .close{border:none;border-radius:var(--pill);padding:10px 12px;background:rgba(12,18,32,.06);cursor:pointer;font-weight:1000}
  .small{font-size:14px;color:rgba(12,18,32,.62);font-weight:800}
  .optgrid{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .opt{border:none;border-radius:var(--pill);padding:12px 12px;background:rgba(12,18,32,.06);
    color:rgba(12,18,32,.78);font-weight:1000;cursor:pointer}
  .opt.on{background:linear-gradient(90deg, rgba(74,163,255,.18), rgba(116,227,176,.18))}
  .foot{display:flex;gap:10px;margin-top:14px;position:sticky;bottom:0;background:rgba(255,255,255,.94);padding:12px 0 0}
  .smallbtn{flex:1;border:none;border-radius:var(--pill);padding:12px 12px;font-weight:1000;cursor:pointer}
  .smallbtn.reset{background:rgba(12,18,32,.06);color:rgba(12,18,32,.78)}
  .smallbtn.apply{background:linear-gradient(90deg,var(--blue),var(--mint));color:#fff}

  /* lane browser */
  .laneGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .lane{border:none;border-radius:18px;padding:14px 14px;background:rgba(12,18,32,.06);cursor:pointer;text-align:left}
  .lane strong{display:block;font-size:14px}
  .lane span{display:block;font-size:12px;color:rgba(12,18,32,.62);font-weight:800;margin-top:6px}
  .lane.on{background:linear-gradient(90deg, rgba(74,163,255,.18), rgba(116,227,176,.18))}

  /* reveal */
  .revealHead{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .revealChip{font-weight:1000;font-size:12px;padding:8px 10px;border-radius:var(--pill);background:rgba(12,18,32,.06);color:rgba(12,18,32,.72);overflow:hidden;position:relative}
  .revealChip::after{content:"";position:absolute;inset:-40%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.9), transparent);
    transform:translateX(-60%) rotate(8deg);animation:sheen 1.15s ease-out 1;}
  @keyframes sheen{to{transform:translateX(60%) rotate(8deg)}}
  .kicker{font-weight:1000;font-size:12px;letter-spacing:.6px;text-transform:uppercase;color:rgba(12,18,32,.55)}
  .slideIn{animation:slideIn .48s cubic-bezier(.2,.9,.2,1) both;}
  @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  /* progress */
  .metaLine{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .progress{width:100%;height:12px;background:rgba(12,18,32,.10);border-radius:var(--pill);overflow:hidden;margin:14px 0 10px}
  .bar{height:100%;width:0%;border-radius:var(--pill);background:linear-gradient(90deg,var(--mint),#60d9ff);
    transition:width 420ms cubic-bezier(.2,.9,.2,1)}

  /* dot world */
  .dotworld{border-radius:var(--r);background:var(--glass2);backdrop-filter:blur(16px);box-shadow:var(--shadow);padding:20px 18px 18px}
  .dotgrid{display:grid;grid-template-columns:repeat(9,1fr);gap:8px;margin-top:10px}
  .dwDot{width:16px;height:16px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%),
               linear-gradient(135deg,var(--blue),var(--mint));opacity:.95}
  .dwDot.halo{box-shadow:0 0 0 2px rgba(255,255,255,.85), 0 0 0 6px rgba(116,227,176,.35)}
  .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:18px;background:rgba(12,18,32,.05);
    color:rgba(12,18,32,.78);font-weight:1000}
  .left{display:flex;align-items:center;gap:10px}
  .badge{width:12px;height:12px;border-radius:50%;background:var(--mint);box-shadow:0 0 0 4px rgba(116,227,176,.18)}
  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .miniChip{font-size:12px;font-weight:1000;padding:9px 10px;border-radius:var(--pill);background:rgba(12,18,32,.06);color:rgba(12,18,32,.72);border:none;cursor:pointer}

  /* nav */
  .nav{display:flex;gap:10px;padding:10px 0 14px}
  .navbtn{flex:1;border:none;border-radius:var(--pill);padding:12px 12px;background:var(--glass);backdrop-filter:blur(12px);
    box-shadow:var(--shadow2);font-weight:1000;cursor:pointer;color:rgba(12,18,32,.78)}
  .navbtn.active{background:var(--glass2);color:rgba(12,18,32,.92)}

  /* toast */
  .toast{position:fixed;left:50%;bottom:92px;transform:translateX(-50%);background:rgba(12,18,32,.86);color:rgba(255,255,255,.94);
    padding:10px 12px;border-radius:14px;font-weight:1000;font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:120}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

  /* confetti burst */
  .burst{position:absolute;width:10px;height:10px;border-radius:50%;pointer-events:none;animation:burst 700ms cubic-bezier(.2,.8,.2,1) forwards;opacity:.95}
  @keyframes burst{from{transform:translate(-50%,-50%) scale(1);opacity:1}
    to{transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.9);opacity:0}}
</style>
</head>
<body class="v1">
<div class="bg"></div><div class="noise"></div>

<div class="shell">
  <header class="topbar">
    <div class="leftstack">
      <button class="backbtn" id="backBtn" aria-label="Back">‚Üê</button>

      <div class="brandpill">
        <div class="mark" aria-hidden="true"><span class="a"></span><span class="b"></span><span class="c"></span><span class="d"></span></div>
        <div class="brand">Gimolo</div>
      </div>

      <div class="tog on" id="soundToggle" role="switch" aria-checked="true" tabindex="0" title="Sound on/off">
        <div class="lbl">SOUND</div><div class="switch"><div class="knob"></div></div>
      </div>

      <div class="tog" id="civicToggle" role="switch" aria-checked="false" tabindex="0" title="Civic mode (invisible mixing)">
        <div class="lbl">CIVIC</div><div class="switch"><div class="knob"></div></div>
      </div>
    </div>

    <button class="iconbtn" id="profileBtn" aria-label="Profile">
      <span class="pulseDot" aria-hidden="true"></span>
      <span class="avatar" aria-hidden="true"></span>
    </button>
  </header>

  <main class="stage" id="stage"></main>

  <nav class="nav">
    <button class="navbtn active" data-screen="spin">Spin</button>
    <button class="navbtn" data-screen="lanes">Lanes</button>
    <button class="navbtn" data-screen="profile">Profile</button>
  </nav>
</div>

<div class="modalScrim" id="mscrim"></div>
<div class="modal" id="modal"></div>
<div class="toast" id="toast"></div>

<script>
/* =========================
   Gimolo v5 ‚Äî "Full engine mechanics" (prototype)
   - Working filters (modal, safe on mobile)
   - Lane browser + lane pin
   - Adaptive engine: tier ramp + scope ramp
   - Cooldowns: avoid repeats + avoid same lane back-to-back when possible
   - Vibe layer: changes palette + biases selection
   - Civic mode: invisible mixing (no civic label until completion/reveal)
   - Completion steering: after completion suggests next lane shift
   ========================= */

const stage = document.getElementById('stage');
const toast = document.getElementById('toast');
const navBtns = [...document.querySelectorAll('.navbtn')];
const profileBtn = document.getElementById('profileBtn');
const soundToggle = document.getElementById('soundToggle');
const civicToggleEl = document.getElementById('civicToggle');
const backBtn = document.getElementById('backBtn');
const body = document.body;
const mscrim = document.getElementById('mscrim');
const modal = document.getElementById('modal');

let audioCtx=null;
let soundOn=true;

let current='spin';
let lastNonProfile='spin';
let currentActivity=null;
let lastScreenBeforeModal=null;

/* --------- app state (engine) --------- */
const state = {
  day: 1,
  completions: 0,
  tier: 1,       // 1..3 (ramp)
  scope: 1,      // 1..3 (micro->mini->depth)
  pinnedLane: null,  // lane id or null
  lastLane: null,
  vibeIndex: 1,  // 1..4
  randomness: 0.55, // perceived control: 0.2..0.8 (affects bias strength)
  civicOn: false,
  recent: [], // recent activity ids
  recentLanes: [], // recent lanes
  recentEmo: [], // emotional load levels
};

const vibeNames = {1:"Playful",2:"Neon",3:"Fresh",4:"Bold"};
function setVibe(i){
  state.vibeIndex=i;
  body.classList.remove('v1','v2','v3','v4');
  body.classList.add('v'+i);
}

/* -------- activity library (trimmed but structured) --------
   Fields:
   - tier: 1..3
   - scope: 1..3
   - lane: one of lanes
   - energy: low/med/high
   - where: home/outside/errands/any
   - emo: 1..3 (emotional load)
   - civic: true/false (invisible until completion if civicOn)
*/
const LANES = [
  {id:"energy-reset", name:"Energy Reset", blurb:"micro calm + easy wins"},
  {id:"meaning-lite", name:"Meaning‚ÄëLight", blurb:"kindness + connection"},
  {id:"creative-spike", name:"Creative Spike", blurb:"visual + playful making"},
  {id:"weekend-depth", name:"Weekend Depth", blurb:"bigger ‚Äòmini quests‚Äô"},
];

const A = [
  // Energy Reset
  {id:"er-breath-30", lane:"energy-reset", tier:1, scope:1, title:"ü´ß 30‚ÄëSecond Reset", desc:"Breathe in for 4, out for 6. Repeat 3 times.", time:"0-5", energy:"low", where:"any", emo:1, civic:false, tags:["reset","calm"]},
  {id:"er-micro-tidy", lane:"energy-reset", tier:1, scope:1, title:"üß∫ Micro Tidy Sprint", desc:"Set 4 minutes. Clear one surface only.", time:"0-5", energy:"low", where:"home", emo:1, civic:false, tags:["reset"]},
  {id:"er-stretch", lane:"energy-reset", tier:1, scope:2, title:"üßò Stretch Stack", desc:"3 stretches. Hold each for 20 seconds.", time:"5-10", energy:"low", where:"home", emo:1, civic:false, tags:["reset","calm"]},
  {id:"er-walk-loop", lane:"energy-reset", tier:2, scope:2, title:"üö∂ 8‚ÄëMin Walk Loop", desc:"Walk a short loop. Notice 5 small details.", time:"5-10", energy:"med", where:"outside", emo:1, civic:false, tags:["fresh","reset"]},
  {id:"er-sound-hunt", lane:"energy-reset", tier:2, scope:2, title:"üëÇ Sound Hunt", desc:"Find 4 different sounds. Guess the source.", time:"5-10", energy:"low", where:"any", emo:1, civic:false, tags:["fresh","calm"]},
  {id:"er-reset-room", lane:"energy-reset", tier:3, scope:3, title:"üåø Reset the Room", desc:"10 minutes: open a window, clear one area, add one ‚Äònice thing‚Äô.", time:"10-20", energy:"med", where:"home", emo:1, civic:false, tags:["reset"]},

  // Meaning-Light
  {id:"ml-3-grat", lane:"meaning-lite", tier:1, scope:1, title:"üôè 3 Gratitudes", desc:"Say 3 specific things you‚Äôre grateful for today.", time:"0-5", energy:"low", where:"any", emo:2, civic:false, tags:["calm","kind"]},
  {id:"ml-compliment", lane:"meaning-lite", tier:1, scope:1, title:"‚ú® Compliment Swap", desc:"Each person gives one specific compliment.", time:"0-5", energy:"low", where:"any", emo:2, civic:false, tags:["kind"]},
  {id:"ml-kind-text", lane:"meaning-lite", tier:1, scope:1, title:"üíå Kind Text", desc:"Send a 2‚Äësentence check‚Äëin to someone you like.", time:"0-5", energy:"low", where:"any", emo:2, civic:true, tags:["kind","civic"]},
  {id:"ml-thanks-note", lane:"meaning-lite", tier:2, scope:2, title:"üìù Tiny Thanks Note", desc:"Write a short thank‚Äëyou note (paper or message).", time:"5-10", energy:"low", where:"home", emo:2, civic:true, tags:["kind","civic"]},
  {id:"ml-memory-minute", lane:"meaning-lite", tier:2, scope:2, title:"üß† Memory Minute", desc:"Share one tiny memory from this week.", time:"5-10", energy:"low", where:"home", emo:2, civic:false, tags:["calm","kind"]},
  {id:"ml-civic-spotlight", lane:"meaning-lite", tier:3, scope:3, title:"ü§ù Micro‚ÄëHelp", desc:"Do one tiny helpful thing for someone nearby today.", time:"0-5", energy:"low", where:"any", emo:2, civic:true, tags:["kind","civic"]},

  // Creative Spike
  {id:"cs-theme-song", lane:"creative-spike", tier:1, scope:1, title:"üéµ Theme Song", desc:"Pick a theme song for today. Play it for 60 seconds.", time:"0-5", energy:"med", where:"any", emo:1, civic:false, tags:["play","bold"]},
  {id:"cs-worst-joke", lane:"creative-spike", tier:1, scope:1, title:"üòÑ Worst Joke Challenge", desc:"Make up the worst joke. Everyone rates it 1‚Äì10.", time:"0-5", energy:"med", where:"any", emo:1, civic:false, tags:["play","bold"]},
  {id:"cs-photo-quest", lane:"creative-spike", tier:2, scope:2, title:"üì∏ Tiny Photo Quest", desc:"Take 3 photos: round, shiny, tiny.", time:"5-10", energy:"med", where:"any", emo:1, civic:false, tags:["play","fresh"]},
  {id:"cs-snack-art", lane:"creative-spike", tier:2, scope:2, title:"üçì Snack Art", desc:"Make a snack look like a face or creature.", time:"5-10", energy:"med", where:"home", emo:1, civic:false, tags:["play"]},
  {id:"cs-nature-color", lane:"creative-spike", tier:2, scope:2, title:"üåø Nature Color Hunt", desc:"Find 3 colors outdoors in 5 minutes. Bonus: make one surprising.", time:"5-10", energy:"med", where:"outside", emo:1, civic:false, tags:["fresh","play"]},
  {id:"cs-mini-poster", lane:"creative-spike", tier:3, scope:3, title:"üñç Mini Poster", desc:"Make a tiny poster for your ‚Äòtoday vibe‚Äô and hang it somewhere.", time:"10-20", energy:"med", where:"home", emo:1, civic:false, tags:["play","bold"]},

  // Weekend Depth
  {id:"wd-mini-build", lane:"weekend-depth", tier:2, scope:3, title:"üß± Mini Build Challenge", desc:"Build the tallest tower using 10 items. Take a photo.", time:"10-20", energy:"high", where:"home", emo:1, civic:false, tags:["play","bold"]},
  {id:"wd-room-escape", lane:"weekend-depth", tier:3, scope:3, title:"üö™ Room Escape Mini", desc:"Hide 3 clues that lead to a tiny ‚Äòtreasure‚Äô.", time:"10-20", energy:"high", where:"home", emo:1, civic:false, tags:["play","bold"]},
  {id:"wd-neighborhood-notice", lane:"weekend-depth", tier:3, scope:3, title:"üó∫ Neighborhood Notice", desc:"Notice 3 things your neighborhood needs (no action required).", time:"10-20", energy:"low", where:"outside", emo:2, civic:true, tags:["fresh","civic"]},
  {id:"wd-community-crumb", lane:"weekend-depth", tier:3, scope:3, title:"üå± Community Crumb", desc:"Pick one small civic-friendly act: pick up 5 pieces of litter or return a stray cart.", time:"10-20", energy:"med", where:"outside", emo:2, civic:true, tags:["civic","kind"]},
];

/* -------- filters (user controllable layer) --------
   These are "intent filters" that constrain the engine.
*/
const filters = {
  time: new Set(),     // 0-5,5-10,10-20,20-40
  energy: new Set(),   // low,med,high
  where: new Set(),    // home,outside,errands,any (we treat any as no filter)
  lanes: new Set(),    // lane ids
};

function filterLabel(set, anyLabel="Any"){
  if(set.size===0) return anyLabel;
  const arr=[...set];
  if(arr.length<=2) return arr.join(", ");
  return arr.slice(0,2).join(", ")+"‚Ä¶";
}
function safeCap(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

/* -------- ramp logic -------- */
function updateRamp(){
  // Tier ramp: 0-2 => tier1, 3-7 => tier2, 8+ => tier3
  const c=state.completions;
  state.tier = (c<3) ? 1 : (c<8 ? 2 : 3);
  // Scope ramp: starts micro; grows with completions but bounded by tier
  state.scope = safeCap(1 + Math.floor(c/4), 1, state.tier);
}

/* -------- safeguards + cooldown -------- */
function recentSet(arr, n){ return new Set(arr.slice(-n)); }

function civicAllowed(a){
  if(!a.civic) return true;
  return state.civicOn; // only include civic activities when toggle ON
}

function matchesFilters(a){
  if(filters.time.size>0 && !filters.time.has(a.time)) return false;
  if(filters.energy.size>0 && !filters.energy.has(a.energy)) return false;
  if(filters.where.size>0){
    // where filter: accept exact match OR a.where==="any"
    if(!(a.where==="any" || filters.where.has(a.where))) return false;
  }
  if(filters.lanes.size>0 && !filters.lanes.has(a.lane)) return false;
  return true;
}

function meetsEngineConstraints(a){
  // tier/scope ramp
  if(a.tier > state.tier) return false;
  if(a.scope > state.scope) return false;

  // emotional safeguard: if last two emo were 3, don't allow emo 3 now
  const r=state.recentEmo;
  if(r.length>=2 && r[r.length-1]===3 && r[r.length-2]===3 && a.emo===3) return false;

  // simple energy safeguard: if user recently got 2 highs, avoid high
  const highCount = state.recent.filter(id=>{
    const x=A.find(z=>z.id===id); return x && x.energy==="high";
  }).length;
  if(highCount>=2 && a.energy==="high") return false;

  // civic gating
  if(!civicAllowed(a)) return false;

  return true;
}

function eligiblePool(){
  updateRamp();

  let list = A.filter(a => meetsEngineConstraints(a) && matchesFilters(a));

  // lane pin overrides lane filters: if pinnedLane set and user hasn't explicitly selected lanes
  if(state.pinnedLane && filters.lanes.size===0){
    const pinned = list.filter(a=>a.lane===state.pinnedLane);
    if(pinned.length>=3) list = pinned; // don't zero out if pin would break
  }

  // cooldown: avoid last 3 activities
  const avoid = recentSet(state.recent, 3);
  const cooled = list.filter(a=>!avoid.has(a.id));
  if(cooled.length>=3) list = cooled;

  // avoid same lane twice in a row when possible
  if(state.lastLane){
    const diffLane = list.filter(a=>a.lane!==state.lastLane);
    if(diffLane.length>=3) list = diffLane;
  }

  return list;
}

/* -------- vibe bias (soft) -------- */
function vibeTag(){
  return (state.vibeIndex===1) ? "play"
    : (state.vibeIndex===2) ? "bold"
    : (state.vibeIndex===3) ? "fresh"
    : "bold";
}

function weightedPick(list){
  if(list.length===0) return null;
  const tag=vibeTag();

  // "randomness" controls how strong the bias is:
  // lower randomness => stronger steering toward tag + pinned lane
  const biasStrength = safeCap(1.2 - state.randomness, 0.2, 0.9);

  const weights = list.map(a=>{
    let w=1;
    if(a.tags?.includes(tag)) w += 0.9*biasStrength;
    if(a.tags?.includes("reset") && state.vibeIndex===3) w += 0.35*biasStrength;
    if(state.pinnedLane && a.lane===state.pinnedLane) w += 0.7*biasStrength;
    return w;
  });

  const total = weights.reduce((s,w)=>s+w,0);
  let r = Math.random()*total;
  for(let i=0;i<list.length;i++){
    r -= weights[i];
    if(r<=0) return list[i];
  }
  return list[list.length-1];
}

/* -------- UI helpers -------- */
function ensureAudio(){
  if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
  if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume(); }
}
function beep({freq=440,dur=0.06,type='sine',gain=0.08}={}){
  if(!soundOn) return;
  try{
    ensureAudio();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=0.0001;
    o.connect(g); g.connect(audioCtx.destination);
    const t=audioCtx.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(gain,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur+0.02);
  }catch(e){}
}
function chime(){
  if(!soundOn) return;
  beep({freq:523,dur:0.07,type:'triangle',gain:0.06});
  setTimeout(()=>beep({freq:659,dur:0.08,type:'triangle',gain:0.06}),70);
  setTimeout(()=>beep({freq:784,dur:0.09,type:'triangle',gain:0.055}),140);
}
function haptic(ms=18){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(e){} }
function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),950); }
function card(inner){ stage.innerHTML=`<div class="card enter">${inner}</div>`; }
function burstFrom(el){
  const r=el.getBoundingClientRect(),cx=r.left+r.width/2,cy=r.top+r.height/2;
  const colors=['#74e3b0','#4aa3ff','#b57bff','#ffb86b','#ff6fb1'];
  for(let i=0;i<18;i++){
    const p=document.createElement('div');
    p.className='burst';
    p.style.left=cx+'px'; p.style.top=cy+'px';
    p.style.background=colors[i%colors.length];
    const a=(Math.PI*2)*(i/18)+(Math.random()*.35);
    const rad=70+Math.random()*70;
    p.style.setProperty('--dx',(Math.cos(a)*rad)+'px');
    p.style.setProperty('--dy',(Math.sin(a)*rad)+'px');
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),740);
  }
}

/* -------- toggles -------- */
function setSoundUI(){
  soundToggle.classList.toggle('on',soundOn);
  soundToggle.setAttribute('aria-checked',soundOn?'true':'false');
}
soundToggle.addEventListener('click',()=>{
  soundOn=!soundOn; setSoundUI(); haptic(12);
  if(soundOn) beep({freq:660,dur:0.05,type:'sine',gain:0.05});
  showToast(soundOn?'Sound on':'Sound off');
});
soundToggle.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault();soundToggle.click();}});
setSoundUI();

function setCivicUI(){
  civicToggleEl.classList.toggle('on', state.civicOn);
  civicToggleEl.setAttribute('aria-checked', state.civicOn?'true':'false');
}
civicToggleEl.addEventListener('click',()=>{
  state.civicOn = !state.civicOn;
  setCivicUI(); haptic(12);
  showToast(state.civicOn ? 'Civic mixing ON (invisible)' : 'Civic mixing OFF');
  renderSpin();
});
civicToggleEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault();civicToggleEl.click();}});
setCivicUI();

/* -------- navigation -------- */
navBtns.forEach(b=>b.addEventListener('click',()=>show(b.dataset.screen)));
profileBtn.addEventListener('click',()=>show('profile'));
backBtn.addEventListener('click',()=>show(lastNonProfile));

function setActive(name){ navBtns.forEach(b=>b.classList.toggle('active',b.dataset.screen===name)); }
function setBackVisibility(){ backBtn.classList.toggle('show', current==='profile'); }

/* -------- modal (filters/adjust/lanes) -------- */
function openModal(renderFn){
  lastScreenBeforeModal=current;
  mscrim.classList.add('show');
  modal.classList.add('show');
  renderFn();
}
function closeModal(){
  mscrim.classList.remove('show');
  modal.classList.remove('show');
  modal.innerHTML='';
}
mscrim.addEventListener('click', closeModal);

function modalHead(title){
  return `
    <div class="modalHead">
      <div class="modalTitle">${title}</div>
      <button class="close" id="mclose">Close</button>
    </div>
  `;
}
function wireClose(){ const c=document.getElementById('mclose'); if(c) c.onclick=closeModal; }

function openFilterModal(type){
  const title = type==="time" ? "Time" : type==="energy" ? "Energy" : type==="where" ? "Where" : "Lane";
  const options = type==="time"
    ? [{k:"0-5",t:"0‚Äì5 min"},{k:"5-10",t:"5‚Äì10 min"},{k:"10-20",t:"10‚Äì20 min"},{k:"20-40",t:"20‚Äì40 min"}]
    : type==="energy"
    ? [{k:"low",t:"Low"},{k:"med",t:"Moderate"},{k:"high",t:"High"}]
    : type==="where"
    ? [{k:"home",t:"Home"},{k:"outside",t:"Outside"},{k:"errands",t:"Errands"}]
    : LANES.map(l=>({k:l.id,t:l.name}));

  const set = (type==="lanes") ? filters.lanes : filters[type];

  openModal(()=>{
    modal.innerHTML = `
      ${modalHead(title)}
      <div class="small">Select one or more. ‚ÄúAny‚Äù clears this filter.</div>
      <div class="optgrid">
        ${options.map(o=>`<button class="opt ${set.has(o.k)?'on':''}" data-k="${o.k}">${o.t}</button>`).join('')}
      </div>
      <div class="foot">
        <button class="smallbtn reset" id="reset">Any</button>
        <button class="smallbtn apply" id="apply">Apply</button>
      </div>
    `;
    wireClose();

    modal.querySelectorAll('.opt').forEach(btn=>{
      btn.onclick=()=>{
        const k=btn.dataset.k;
        if(set.has(k)) set.delete(k); else set.add(k);
        btn.classList.toggle('on');
        haptic(8); beep({freq:520,dur:0.04,type:'sine',gain:0.03});
      };
    });

    document.getElementById('reset').onclick=()=>{
      set.clear(); closeModal(); renderSpin(); showToast(title+': Any');
    };
    document.getElementById('apply').onclick=()=>{
      closeModal(); renderSpin(); showToast('Filters applied');
    };
  });
}

function openAdjustModal(){
  openModal(()=>{
    modal.innerHTML = `
      ${modalHead("Adjust")}
      <div class="small">Vibe changes the look + gently steers the engine (still random).</div>

      <div class="div"></div>
      <div class="small">Vibe</div>
      <div class="optgrid">
        ${[1,2,3,4].map(i=>`<button class="opt ${state.vibeIndex===i?'on':''}" data-v="${i}">${vibeNames[i]}</button>`).join('')}
      </div>

      <div class="div"></div>
      <div class="small">Perceived control</div>
      <div class="p" style="margin-top:8px">More control = more steering toward your vibe/lane.</div>
      <input id="rand" type="range" min="0.20" max="0.80" step="0.01" value="${state.randomness}" style="width:100%;margin-top:8px"/>
      <div class="small" style="margin-top:8px">Randomness: <span id="randVal">${state.randomness.toFixed(2)}</span></div>

      <div class="div"></div>
      <div class="small">Lane pin</div>
      <div class="p" style="margin-top:8px">Pin a lane to keep momentum (unless you pick specific lanes in filters).</div>
      <div class="laneGrid">
        ${LANES.map(l=>`
          <button class="lane ${state.pinnedLane===l.id?'on':''}" data-l="${l.id}">
            <strong>${l.name}</strong>
            <span>${l.blurb}</span>
          </button>`).join('')}
      </div>
      <button class="btn secondary" id="clearPin" style="margin-top:12px">Clear pin</button>
    `;
    wireClose();

    modal.querySelectorAll('.opt[data-v]').forEach(b=>{
      b.onclick=()=>{
        const v=Number(b.dataset.v);
        setVibe(v);
        modal.querySelectorAll('.opt[data-v]').forEach(x=>x.classList.toggle('on', Number(x.dataset.v)===v));
        haptic(10); chime(); renderSpin();
      };
    });

    const r=document.getElementById('rand');
    const rv=document.getElementById('randVal');
    r.oninput=()=>{ state.randomness=Number(r.value); rv.textContent=state.randomness.toFixed(2); haptic(6); };
    r.onchange=()=>{ showToast('Control updated'); renderSpin(); };

    modal.querySelectorAll('.lane').forEach(b=>{
      b.onclick=()=>{
        const id=b.dataset.l;
        state.pinnedLane = (state.pinnedLane===id) ? null : id;
        modal.querySelectorAll('.lane').forEach(x=>x.classList.toggle('on', x.dataset.l===state.pinnedLane));
        haptic(10); beep({freq:600,dur:0.05,type:'triangle',gain:0.04});
        renderSpin();
      };
    });

    document.getElementById('clearPin').onclick=()=>{
      state.pinnedLane=null;
      modal.querySelectorAll('.lane').forEach(x=>x.classList.remove('on'));
      haptic(10); showToast('Lane pin cleared'); renderSpin();
    };
  });
}

/* -------- screens -------- */
function countEligible(){
  return eligiblePool().length;
}

function renderSpin(){
  const timeVal = filterLabel(filters.time);
  const energyVal = filterLabel(filters.energy);
  const whereVal = filterLabel(filters.where);
  const laneVal = (filters.lanes.size===0) ? "Any" : `${filters.lanes.size} lane${filters.lanes.size>1?'s':''}`;
  const matches = countEligible();

  stage.innerHTML = `
    <div class="spinWrap enter">
      <div class="filters">
        <button class="chip" id="fTime"><span class="dot"></span>Time <span class="val">${timeVal}</span></button>
        <button class="chip" id="fEnergy"><span class="dot"></span>Energy <span class="val">${energyVal}</span></button>
        <button class="chip" id="fWhere"><span class="dot"></span>Where <span class="val">${whereVal}</span></button>
        <button class="chip" id="fLane"><span class="dot"></span>Lane <span class="val">${laneVal}</span></button>
        <button class="chip" id="fAdjust"><span class="dot"></span>Adjust <span class="count">(${vibeNames[state.vibeIndex]})</span></button>
      </div>

      <div class="orbGlow" aria-hidden="true"></div>
      <button class="orb" id="spinOrb">SPIN</button>

      <button class="subpill" id="meta">
        Matches: <strong>${matches}</strong> ‚Ä¢
        Tier: <strong>${state.tier}</strong> ‚Ä¢ Scope: <strong>${state.scope}</strong>
        ${state.pinnedLane ? `<br/><small>Pinned: ${LANES.find(l=>l.id===state.pinnedLane)?.name || 'Lane'}</small>` : ''}
      </button>
    </div>
  `;

  document.getElementById('fTime').onclick=()=>openFilterModal('time');
  document.getElementById('fEnergy').onclick=()=>openFilterModal('energy');
  document.getElementById('fWhere').onclick=()=>openFilterModal('where');
  document.getElementById('fLane').onclick=()=>openFilterModal('lanes');
  document.getElementById('fAdjust').onclick=openAdjustModal;

  document.getElementById('meta').onclick=()=>{
    showToast(matches===0 ? 'No matches ‚Äî clear a filter' : 'Ready');
    haptic(8);
  };

  document.getElementById('spinOrb').onclick=(e)=>{
    haptic(22);
    beep({freq:220,dur:0.05,type:'sine',gain:0.05});
    setTimeout(()=>beep({freq:330,dur:0.05,type:'sine',gain:0.05}),45);
    setTimeout(()=>beep({freq:440,dur:0.06,type:'sine',gain:0.06}),95);

    const pool=eligiblePool();
    const pick=weightedPick(pool);
    if(!pick){
      showToast('No matches ‚Äî tap a filter and choose ‚ÄúAny‚Äù');
      haptic(18);
      return;
    }

    burstFrom(e.currentTarget);
    currentActivity=pick;
    show('activity');
  };
}

function renderLanes(){
  const pinned = state.pinnedLane;
  card(`
    <div class="revealHead">
      <div>
        <div class="kicker">Lane Browser</div>
        <div class="small">Pick a lane to pin, or leave it open.</div>
      </div>
      <div class="revealChip">LANES</div>
    </div>

    <div class="laneGrid">
      ${LANES.map(l=>`
        <button class="lane ${pinned===l.id?'on':''}" data-l="${l.id}">
          <strong>${l.name}</strong>
          <span>${l.blurb}</span>
        </button>`).join('')}
    </div>

    <button class="btn primary" id="backSpin" style="margin-top:14px">Back to Spin</button>
    <button class="btn secondary" id="clear" style="margin-top:10px">Clear pin</button>
  `);

  stage.querySelectorAll('.lane').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.l;
      state.pinnedLane = (state.pinnedLane===id) ? null : id;
      stage.querySelectorAll('.lane').forEach(x=>x.classList.toggle('on', x.dataset.l===state.pinnedLane));
      haptic(10); beep({freq:600,dur:0.05,type:'triangle',gain:0.04});
      renderSpin(); // keep matches updated even if user goes back
    };
  });
  document.getElementById('backSpin').onclick=()=>show('spin');
  document.getElementById('clear').onclick=()=>{
    state.pinnedLane=null;
    stage.querySelectorAll('.lane').forEach(x=>x.classList.remove('on'));
    haptic(10); showToast('Lane pin cleared'); renderSpin();
  };
}

function renderActivity(){
  const a=currentActivity || A[0];

  // Invisible civic mixing: do NOT label as civic here.
  const civicHidden = state.civicOn && a.civic;

  const laneName = LANES.find(l=>l.id===a.lane)?.name || "Lane";
  const timeLabel = a.time==='0-5'?'0‚Äì5 min':a.time.replace('-','‚Äì')+' min';
  const energyLabel = (a.energy==='med') ? 'Moderate' : a.energy[0].toUpperCase()+a.energy.slice(1);

  card(`
    <div class="revealHead slideIn">
      <div class="revealTitle">
        <div class="kicker">Your next move</div>
        <div class="small">Lane: <strong>${laneName}</strong> ‚Ä¢ Vibe: <strong>${vibeNames[state.vibeIndex]}</strong></div>
      </div>
      <div class="revealChip">REVEAL ‚ú®</div>
    </div>

    <div class="tagrow">
      <span class="tag"><i>‚è±</i> ${timeLabel}</span>
      <span class="tag"><i>‚ö°</i> ${energyLabel}</span>
      <span class="tag"><i>üìç</i> ${a.where==='any'?'Anywhere':a.where[0].toUpperCase()+a.where.slice(1)}</span>
      <span class="tag"><i>üéö</i> Tier ${a.tier} ‚Ä¢ Scope ${a.scope}</span>
    </div>

    <h1 class="h1 slideIn" style="animation-delay:.06s">${a.title}</h1>
    <p class="p slideIn" style="animation-delay:.10s">${a.desc}</p>

    <div class="div"></div>

    <button class="btn primary" id="start">Start ‚Üí</button>
    <button class="btn secondary" id="again">Spin again</button>
    <button class="btn ghost" id="adjust">Adjust</button>

    ${civicHidden ? `<div class="p" style="margin-top:12px"><strong>Note:</strong> Civic mixing is ON (this may include a community ripple).</div>` : ``}
  `);

  chime(); haptic(10);

  document.getElementById('start').onclick=(e)=>{
    haptic(18); beep({freq:520,dur:0.06,type:'triangle',gain:0.06}); burstFrom(e.currentTarget);
    show('progress');
  };
  document.getElementById('again').onclick=()=>{ haptic(12); beep({freq:420,dur:0.05,type:'sine',gain:0.04}); show('spin'); };
  document.getElementById('adjust').onclick=()=>{ haptic(10); beep({freq:600,dur:0.05,type:'triangle',gain:0.04}); openAdjustModal(); };
}

function renderProgress(){
  const a=currentActivity || A[0];
  const seconds = (a.scope===1) ? 120 : (a.scope===2 ? 240 : 480); // micro/mini/depth
  let secs=seconds;

  card(`
    <div class="metaLine">
      <div class="h2">In Progress</div>
      <div class="small">‚è± <span id="timer">${fmt(secs)}</span></div>
    </div>

    <p class="p"><strong>${a.title}</strong><br/>Try it now ‚Äî keep it lightweight.</p>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <button class="btn primary" id="done">Mark as Done</button>
    <button class="btn secondary" id="skip">Spin again</button>
    <button class="btn ghost" id="profileGo">Profile</button>
  `);

  requestAnimationFrame(()=>document.getElementById('bar').style.width='66%');

  const t=document.getElementById('timer');
  const iv=setInterval(()=>{
    secs=Math.max(0,secs-1);
    t.textContent=fmt(secs);
    if(secs===0) clearInterval(iv);
  },1000);

  document.getElementById('done').onclick=(e)=>{
    clearInterval(iv);
    haptic(30); chime(); burstFrom(e.currentTarget);
    applyCompletion(a);
    show('complete');
  };
  document.getElementById('skip').onclick=()=>{
    clearInterval(iv);
    haptic(12); beep({freq:420,dur:0.05,type:'sine',gain:0.04});
    show('spin');
  };
  document.getElementById('profileGo').onclick=()=>{ clearInterval(iv); show('profile'); };
}

function renderComplete(){
  const a=currentActivity || A[0];
  const lane = LANES.find(l=>l.id===a.lane)?.name || "Lane";
  const civicReveal = state.civicOn && a.civic;

  // Completion steering suggestion: shift to adjacent lane or keep
  const nextLane = suggestNextLane(a.lane);
  const nextLaneName = LANES.find(l=>l.id===nextLane)?.name || "Next";

  card(`
    <div class="revealHead">
      <div>
        <div class="kicker">Complete</div>
        <div class="small">Dot added ‚Ä¢ Tier now <strong>${state.tier}</strong> ‚Ä¢ Scope now <strong>${state.scope}</strong></div>
      </div>
      <div class="revealChip">DONE ‚ú®</div>
    </div>

    <h2 class="h2">${a.title}</h2>
    <p class="p">Lane: <strong>${lane}</strong></p>

    ${civicReveal ? `
      <div class="div"></div>
      <div class="tagrow">
        <span class="tag"><i>üåé</i> Community ripple revealed</span>
        <span class="tag"><i>üôà</i> It was invisible until now</span>
      </div>
      <p class="p">This was a civic-mode activity, blended into your normal spins.</p>
    ` : ``}

    <div class="div"></div>

    <button class="btn primary" id="spinNext">Spin again</button>
    <button class="btn secondary" id="keepLane">Keep lane: ${lane}</button>
    <button class="btn ghost" id="shiftLane">Shift lane: ${nextLaneName}</button>
  `);

  document.getElementById('spinNext').onclick=()=>{ haptic(12); beep({freq:420,dur:0.05,type:'sine',gain:0.04}); show('spin'); };
  document.getElementById('keepLane').onclick=()=>{
    state.pinnedLane = a.lane;
    haptic(10); showToast('Pinned: '+lane); renderSpin(); show('spin');
  };
  document.getElementById('shiftLane').onclick=()=>{
    state.pinnedLane = nextLane;
    haptic(10); showToast('Pinned: '+nextLaneName); renderSpin(); show('spin');
  };
}

function renderProfile(){
  let dots='';
  for(let i=0;i<45;i++){
    const halo=(i===6||i===19||i===33)?'halo':'';
    dots+=`<div class="dwDot ${halo}"></div>`;
  }

  const recent = state.recent.slice(-4).reverse().map(id=>{
    const a=A.find(x=>x.id===id);
    if(!a) return null;
    return {title:a.title, lane: LANES.find(l=>l.id===a.lane)?.name || 'Lane'};
  }).filter(Boolean);

  stage.innerHTML=`
    <div class="dotworld enter">
      <h2 class="h2">Your Dot World</h2>
      <p class="p">Momentum, not stats. (Prototype)</p>

      <div class="tagrow" style="margin-top:10px;">
        <span class="tag"><i>üß†</i> Tier ${state.tier} ‚Ä¢ Scope ${state.scope}</span>
        <span class="tag"><i>üé®</i> Vibe: ${vibeNames[state.vibeIndex]}</span>
        <span class="tag"><i>üåé</i> Civic: ${state.civicOn ? 'ON (invisible)' : 'OFF'}</span>
      </div>

      <div class="dotgrid">${dots}</div>

      <div class="div"></div>

      <div class="small"><strong>Recent</strong></div>
      <div class="list">
        ${recent.length ? recent.map(r=>`
          <div class="item">
            <div class="left"><span class="badge"></span>${r.title}</div>
            <span style="opacity:.7">${r.lane}</span>
          </div>`).join('') : `
          <div class="item"><div class="left"><span class="badge"></span>No history yet</div><span>‚Ä∫</span></div>
        `}
      </div>

      <div class="chipline">
        <button class="miniChip" id="resetFilters">Reset filters</button>
        <button class="miniChip" id="adjust">Adjust</button>
        <button class="miniChip" id="backToPrev">Back</button>
      </div>
    </div>
  `;
  document.getElementById('resetFilters').onclick=()=>{ filters.time.clear(); filters.energy.clear(); filters.where.clear(); filters.lanes.clear(); showToast('Filters reset'); renderSpin(); };
  document.getElementById('adjust').onclick=openAdjustModal;
  document.getElementById('backToPrev').onclick=()=>show(lastNonProfile);
}

/* -------- completion update -------- */
function applyCompletion(a){
  state.completions += 1;
  state.day = 1 + Math.floor(state.completions/2);

  // track recents for cooldown + safeguards
  state.recent.push(a.id);
  state.recent = state.recent.slice(-12);

  state.recentLanes.push(a.lane);
  state.recentLanes = state.recentLanes.slice(-8);

  state.recentEmo.push(a.emo);
  state.recentEmo = state.recentEmo.slice(-6);

  state.lastLane = a.lane;

  updateRamp();
}

/* -------- steering suggestion -------- */
function suggestNextLane(currentLane){
  const idx = LANES.findIndex(l=>l.id===currentLane);
  if(idx<0) return LANES[0].id;
  // simple cycle with a bit of randomness
  const step = (Math.random()<0.5) ? 1 : 2;
  return LANES[(idx+step) % LANES.length].id;
}

function fmt(secs){
  const m=Math.floor(secs/60), s=secs%60;
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

function show(screen){
  current=screen;
  setActive(screen);
  setBackVisibility();
  if(screen!=='profile') lastNonProfile=screen;

  if(screen==='spin'){ renderSpin(); return; }
  if(screen==='lanes'){ renderLanes(); return; }
  if(screen==='activity'){ renderActivity(); return; }
  if(screen==='progress'){ renderProgress(); return; }
  if(screen==='complete'){ renderComplete(); return; }
  if(screen==='profile'){ renderProfile(); return; }
}

/* init */
setVibe(state.vibeIndex);
show('spin');
</script>
</body>
</html>
